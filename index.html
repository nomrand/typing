<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Optional CSS -->
    <link rel="stylesheet" href="css/box.css">

    <title>TYPING</title>
</head>

<body>
    <div class="m-1">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#">Game</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="chart.html">Chart</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="score.html">Ranking</a>
            </li>

            <div class="ml-auto mt-auto">
                <span class="font-weight-light">
                    <label for="UserNameText">User:</label>
                </span>
                <input type="input" id="UserNameText">
            </div>
        </ul>
    </div>

    <div class="container" style="height: 90%;">
        <div class="h-75">
            <div class="h-100 rounded" id="gscreen">
                <!--GAME SCREEN -->
            </div>
        </div>

        <div class="h-25">
            <div class="row">
                <div class="col text-left" id="words_to_clear">
                    <span class="font-weight-light">Words Remain:</span>
                    <!-- Word Circle -->
                </div>
            </div>

            <div class="w-100">
                <span class="w-100 font-weight-light">
                    <label for="InputText">Press Word Below:</label>
                </span>
                <input class="w-100" type="input" id="InputText" disabled>
            </div>

            <button class="btn btn-outline-secondary mt-3" id="GameStartButton" disabled>Game Start</button>
            <!--
                <button class="btn" id="UserDataClearButton">All User Data Clear</button>
            -->
        </div>
    </div>

    <div class="modal fade" id="ResultModal" tabindex="-1" role="dialog" aria-labelledby="ResultModalLabel"
        aria-hidden="true" data-backdrop="static" data-show="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ResultModalLabel">Result</h5>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">User:</div>
                        <div class="col-6" id="res_user"></div>
                        <div class="col-6">Started at:</div>
                        <div class="col-6" id="res_start"></div>
                        <div class="col-6">Time:</div>
                        <div class="col-6" id="res_time"></div>
                        <div class="col-6">success:</div>
                        <div class="col-6" id="res_get"></div>
                        <div class="col-6">fail:</div>
                        <div class="col-6" id="res_lose"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div>Save this result?</div>
                    <div class="m-3">
                        <button type="button" id="ResultSaveClose" class="btn btn-primary" data-dismiss="modal">
                            Close with Save
                        </button>
                        <button type="button" id="ResultNoSaveClose" class="btn btn-secondary" data-dismiss="modal">
                            Close without Save
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <script src="js/data.js"></script>
    <script src="js/storedata.js"></script>
    <script src="js/store.legacy.min.js"></script>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <script>
        // TODO show if session unconnected
        //        $('#LoginModal').modal('show');
        // TODO check before close event
        //     $('#LoginModalCloseButton').on(function (e) {
        //         alert("not close");
        //         return false;
        //     });

        $(function () {
            $('#UserDataClearButton').click(function () {
                clearAllUserData();
            });
            $('#GameStartButton').click(function () {
                // TODO START
                gameStart();
                $(this).prop("disabled", true);
            });

            $('#InputText').keyup(function (e) {
                var val = $('#InputText').val();
                if (!val) {
                    return false;
                }

                $(".wordcell").each(function (index, element) {
                    if ($(element).text() == val) {
                        // GET WORD
                        $(element).trigger("dltFnc");
                        $('#InputText').val('');

                        // CREATE
                        createWord(WordData[WordIndex++]);
                    } else if ($(element).text().startsWith(val)) {
                        if ($(element).text().length - val.length <= 2) {
                            $(element).removeClass("wordnormal");
                            $(element).removeClass("wordwarning");
                            $(element).addClass("wordfatal");
                        } else {
                            $(element).removeClass("wordnormal");
                            $(element).removeClass("wordfatal");
                            $(element).addClass("wordwarning");
                        }
                    } else {
                        $(element).removeClass("wordwarning");
                        $(element).removeClass("wordfatal");
                        $(element).addClass("wordnormal");
                    }
                });

                return false;
            });

            $('#UserNameText').keyup(function (e) {
                loginUser();
                return false;
            });
            $('#UserNameText').val(getCurrentUser());
            loginUser();


            $('#ResultSaveClose').click(function (e) {
                appendUserData($('#UserNameText').val(), ResultData);
            });
        });


        function loginUser() {
            var val = $('#UserNameText').val();
            setCurrentUser(val);
            if (!val) {
                $('.nav-link').addClass('disabled');
                $('#GameStartButton').prop("disabled", true);
                return false;
            }

            $('.nav-link').removeClass('disabled');
            $('#GameStartButton').prop("disabled", false);
            return true;
        }

        let startTime = 0;

        let getCount = 0;
        let getLength = 0;
        let loseCount = 0;
        let loseLength = 0;

        let ResultData = {};
        let WordIndex = 0;
        function gameStart() {
            // INIT
            if (typeof WordData == 'undefined') {
                WordData = [];
            }
            if (typeof WordMax == 'undefined' || WordMax > WordData.length) {
                WordMax = WordData.length;
            }
            WordData.sort(function () { return Math.random() - .5 });
            ResultData = {};
            WordIndex = 0;

            getCount = 0;
            getLength = 0;
            loseCount = 0;
            loseLength = 0;
            startTime = Date.now();

            $('#UserNameText').prop("disabled", true);
            $('#InputText').val('');
            $('#InputText').prop("disabled", false);

            for (var i = 0; i < WordMax; i++) {
                var wordCircle = $('<div class="rounded-circle cirIndicator wordcircle"></div>');
                $("#words_to_clear").append(wordCircle);
            }

            createWord(WordData[WordIndex++]);
        }

        function winlose(isWin, word) {
            if (isWin) {
                getCount++;
                getLength += word.length;
            } else {
                loseCount++;
                loseLength += word.length;
            }

            var words = $(".wordcircle");
            words.first().remove();

            if (getCount + loseCount == WordMax) {
                gameEnd();
            }
        }

        function createWord(word) {
            if (!word) {
                return false;
            }

            var wordDom = $('<div class="rounded text-center p-2 wordcell wordnormal"></div>');
            wordDom.text(word);
            $("#gscreen").append(wordDom);

            var maxLeft = $("#gscreen").width() - wordDom.width();
            wordDom.css({
                left: Math.floor(Math.random() * maxLeft) + "px",
            });

            wordDom.animate(
                {
                    top: "100%",
                },
                20000, "linear", function () {
                    winlose(false, word);
                }
            );

            wordDom.bind("dltFnc", function () {
                $(this).stop();
                $(this).animate(
                    {
                        height: "0%",
                        width: "0%",
                    },
                    100, "linear", function () {
                        $(this).remove();

                        winlose(true, word);
                    }
                );
            });
        }

        function gameEnd() {
            var endTime = Date.now();
            ResultData = {
                start: startTime,
                time: endTime - startTime,
                get: getCount,
                getLength: getLength,
                lose: loseCount,
                loseLength: loseLength,
            };

            $('#res_user').text($('#UserNameText').val());
            $('#res_start').text(formatDate(new Date(ResultData.start)));
            $('#res_time').text((Math.floor(ResultData.time / 100) / 10) + "sec");
            $('#res_get').text(ResultData.get + "words (" + ResultData.getLength + ")");
            $('#res_lose').text(ResultData.lose + "words (" + ResultData.loseLength + ")");
            $('#ResultModal').modal('show');

            $('#UserNameText').prop("disabled", false);
            $('#InputText').val('');
            $('#InputText').prop("disabled", true);

            $('#GameStartButton').prop("disabled", false);
        }
    </script>
</body>

</html>